name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          debug: true
          script: |
            set -e  # Para execuÃ§Ã£o se houver erro
            
            PROJECT_DIR="/srv/docker/controle-indicacoes"
            REPO_URL="https://github.com/camargommc2021-star/controle_de_indicacoes.git"
            
            echo "ðŸ” === DEBUG INFO ==="
            echo "DiretÃ³rio do projeto: $PROJECT_DIR"
            echo "UsuÃ¡rio: $(whoami)"
            echo "Docker versÃ£o: $(docker --version || echo 'DOCKER NÃƒO ENCONTRADO')"
            echo "Docker Compose: $(docker compose version || echo 'DOCKER COMPOSE NÃƒO ENCONTRADO')"
            echo ""
            
            # Criar diretÃ³rio se nÃ£o existir
            echo "ðŸ“ Criando diretÃ³rio se necessÃ¡rio..."
            sudo mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "DiretÃ³rio atual: $(pwd)"
            echo ""
            
            # Clone ou pull
            if [ ! -d ".git" ]; then
              echo "ðŸ”„ Clonando repositÃ³rio..."
              sudo git clone "$REPO_URL" .
            else
              echo "ðŸ”„ Atualizando repositÃ³rio..."
              sudo git fetch origin main
              sudo git reset --hard origin/main
              sudo git clean -fd
            fi
            echo ""
            
            # Verificar se arquivos existem
            echo "ðŸ“‹ Verificando arquivos essenciais:"
            ls -la docker-compose.prod.yml Dockerfile requirements.txt app.py
            echo ""
            
            # Verificar rede proxy
            echo "ðŸŒ Verificando rede 'proxy':"
            docker network ls | grep proxy || echo "âš ï¸ REDE 'proxy' NÃƒO ENCONTRADA! Criando..."
            docker network inspect proxy 2>/dev/null || docker network create proxy
            echo ""
            
            # Build e deploy
            echo "ðŸ³ Iniciando build..."
            sudo docker compose -f docker-compose.prod.yml down 2>/dev/null || true
            sudo docker compose -f docker-compose.prod.yml build --no-cache 2>&1
            echo ""
            
            echo "ðŸš€ Iniciando containers..."
            sudo docker compose -f docker-compose.prod.yml up -d --force-recreate 2>&1
            echo ""
            
            # Verificar status
            echo "ðŸ“Š Status dos containers:"
            sudo docker compose -f docker-compose.prod.yml ps
            echo ""
            
            # Verificar logs (Ãºltimas 20 linhas)
            echo "ðŸ“ Ãšltimos logs:"
            sudo docker compose -f docker-compose.prod.yml logs --tail=20 2>&1 || echo "NÃ£o foi possÃ­vel obter logs"
            echo ""
            
            # Limpeza
            echo "ðŸ§¹ Limpando imagens antigas..."
            sudo docker image prune -f
            
            echo ""
            echo "âœ… Deploy concluÃ­do!"
